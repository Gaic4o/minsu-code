"use strict";(self.webpackChunkminsucode_front=self.webpackChunkminsucode_front||[]).push([[474],{3474:(e,t,n)=>{n.r(t),n.d(t,{default:()=>b});var r=n(7294),o=n(8575),a=n(3564),l=n(9732),c=n(6182),i=n.n(c),u=n(5977),s=n(8678),f=n(2309),m=n(2545),d=n(9669),g=n.n(d),v=n(8667),p=n(2951),h=n(9249);function S(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],l=!0,c=!1;try{for(n=n.call(e);!(l=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{l||null==n.return||n.return()}finally{if(c)throw o}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}const b=function(){var e,t,n=(0,u.UO)(),c=n.workspace,d=n.id,T=(0,o.ZP)("/api/workspaces/".concat(c,"/users/").concat(d),a.Z).data,b=(0,o.ZP)("/api/users",a.Z).data,k=S((0,s.Z)(""),3),y=k[0],w=k[1],E=k[2],C=(0,o.g_)((function(e){return"/api/workspaces/".concat(c,"/dms/").concat(d,"/chats?perPage=20&page=").concat(e+1)}),a.Z),D=C.data,Z=C.mutate,A=C.revalidate,I=C.setSize,B=S((0,p.Z)(c),1)[0],O=0===(null==D||null===(e=D[0])||void 0===e?void 0:e.length),R=O||D&&(null===(t=D[D.length-1])||void 0===t?void 0:t.length)<20||!1,j=(0,r.useRef)(null),F=S((0,r.useState)(!1),2),P=F[0],_=F[1],x=(0,r.useCallback)((function(e){e.preventDefault(),console.log(e);var t=new FormData;if(e.dataTransfer.items){for(var n=0;n<e.dataTransfer.items.length;n++)if("file"===e.dataTransfer.items[n].kind){var r=e.dataTransfer.items[n].getAsFile();console.log("... file["+n+"].name = "+r.name),t.append("image",r)}}else for(var o=0;o<e.dataTransfer.files.length;o++)console.log("... file["+o+"].name = "+e.dataTransfer.files[o].name),t.append("image",e.dataTransfer.files[o]);g().post("/api/workspaces/".concat(c,"/dms/").concat(d,"/images"),t).then((function(){_(!1),localStorage.setItem("".concat(c,"-").concat(d),(new Date).getTime().toString()),A()}))}),[c,d]),z=(0,r.useCallback)((function(e){e.preventDefault(),console.log(e),_(!0)}),[]),H=(0,r.useCallback)((function(e){if(e.preventDefault(),null!=y&&y.trim()&&D){var t=y;Z((function(e){var n;return null==e||e[0].unshift({id:((null===(n=D[0][0])||void 0===n?void 0:n.id)||0)+1,content:t,SenderId:b.id,Sender:b,ReceiverId:T.id,Receiver:T,createdAt:new Date}),e}),!1).then((function(){var e;localStorage.setItem("".concat(c,"-").concat(d),(new Date).getTime().toString()),E(""),j.current&&(console.log("scrollToBottom!",null===(e=j.current)||void 0===e?void 0:e.getValues()),j.current.scrollToBottom())})),g().post("/api/workspaces/".concat(c,"/dms/").concat(d,"/chats"),{content:y}).then((function(){A(),E("")})).catch(console.error)}}),[y,c,d,b,T,D]),N=(0,r.useCallback)((function(e){e.SenderId===Number(d)&&b.id!==Number(d)&&Z((function(t){return null==t||t[0].unshift(e),t}),!1).then((function(){var e;j.current&&(j.current.getScrollHeight()<j.current.getClientHeight()+j.current.getScrollTop()+150?(console.log("scrollToBottom!",null===(e=j.current)||void 0===e?void 0:e.getValues()),setTimeout((function(){var e;null===(e=j.current)||void 0===e||e.scrollToBottom()}),100)):h.Am.success("새 메시지가 도착했습니다.",{onClick:function(){var e;null===(e=j.current)||void 0===e||e.scrollToBottom()},closeOnClick:!0}))}))}),[d,b,Z]);if((0,r.useEffect)((function(){localStorage.setItem("".concat(c,"-").concat(d),(new Date).getTime().toString())}),[c,d]),(0,r.useEffect)((function(){return null==B||B.on("dm",N),function(){null==B||B.off("dm",N)}}),[B,onmessage]),(0,r.useEffect)((function(){var e;1===(null==D?void 0:D.length)&&(null===(e=j.current)||void 0===e||e.scrollToBottom())}),[]),!T||!b)return null;var U=(0,v.Z)(D?D.flat().reverse():[]);return r.createElement(l.W2,{onDrop:x,onDragOver:z},r.createElement(l.h4,null,r.createElement("img",{src:i().url(T.email,{s:"24px",d:"monsterid"}),alt:T.nickname}),r.createElement("span",null,T.nickname)),r.createElement(m.Z,{chatSections:U,scrollRef:j,setSize:I,isEmpty:O,isReachingEnd:R}),r.createElement(f.Z,{chat:y,onChangeChat:w,onSubmitForm:H}),P&&r.createElement(l.KW,null,"업로드!"))}}}]);